<form method="post" action="{% url 'website:ilan_olustur' %}">
    {% csrf_token %}
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{message.tags}} alert-dismissible fade show" role="alert">
            {{message}}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}

    <div class="card mb-3 shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-4">
                <i class="bi bi-info-circle me-2"></i>Temel Bilgiler
            </h5>
            <div class="mb-3">
                <label class="form-label">Başlık *</label>
                <input type="text" class="form-control" name="title" required placeholder="Örn: İstanbul'dan Ankara'ya mobilya taşıma">
            </div>
            <div class="mb-3">
                <label class="form-label">Açıklama</label>
                <textarea class="form-control" name="description" rows="3" placeholder="Yükünüz hakkında detaylı bilgi verin"></textarea>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Yük Tipi *</label>
                    <select class="form-select" name="cargo_type" id="cargo_type" required>
                        {% for value, label in cargo_types %}
                        <option value="{{value}}" {% if prefill.cargo_type == value %}selected{% endif %}>{{label}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Telefon *</label>
                    <input type="tel" class="form-control" name="phone" required placeholder="5XX XXX XX XX">
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3 shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-4">
                <i class="bi bi-geo-alt me-2"></i>Alış Adresi
            </h5>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Şehir *</label>
                    <input type="text" class="form-control city-autocomplete" name="from_city" id="from_city" required placeholder="Örn: İstanbul" autocomplete="off" list="cities-list" value="{{ prefill.from_city|default:'' }}">
                    <datalist id="cities-list"></datalist>
                </div>
                <div class="col-md-6">
                    <label class="form-label">İlçe *</label>
                    <input type="text" class="form-control" name="from_district" required placeholder="Örn: Kadıköy">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Adres *</label>
                <textarea class="form-control" name="from_address" rows="2" required placeholder="Mahalle, sokak, bina no vb."></textarea>
            </div>

            <!-- Evden Eve/Ofis Taşıma İçin Ek Sorular - Alış Adresi -->
            <div class="moving-details" style="display: none;">
                <h6 class="text-muted mb-3">Alış Adresi Detayları</h6>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Kat Numarası</label>
                        <input type="number" class="form-control" name="from_floor" min="0" max="50" placeholder="Örn: 3">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Daire (Oda Sayısı)</label>
                        <select class="form-select" name="from_room_count">
                            <option value="">Seçiniz</option>
                            <option value="1+0">1+0</option>
                            <option value="1+1">1+1</option>
                            <option value="2+1">2+1</option>
                            <option value="3+1">3+1</option>
                            <option value="4+1">4+1</option>
                            <option value="5+1">5+1 ve üzeri</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="from_has_elevator" id="from_has_elevator" value="true">
                            <label class="form-check-label" for="from_has_elevator">
                                Normal Asansör Var
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="from_has_freight_elevator" id="from_has_freight_elevator" value="true">
                            <label class="form-check-label" for="from_has_freight_elevator">
                                Yük Asansörü Var
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="card-title mt-4 mb-4">
                <i class="bi bi-geo-fill me-2"></i>Teslim Adresi
            </h5>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Şehir *</label>
                    <input type="text" class="form-control city-autocomplete" name="to_city" id="to_city" required placeholder="Örn: Ankara" autocomplete="off" list="cities-list" value="{{ prefill.to_city|default:'' }}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">İlçe *</label>
                    <input type="text" class="form-control" name="to_district" required placeholder="Örn: Çankaya">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Adres *</label>
                <textarea class="form-control" name="to_address" rows="2" required placeholder="Mahalle, sokak, bina no vb."></textarea>
            </div>

            <!-- Evden Eve/Ofis Taşıma İçin Ek Sorular - Teslim Adresi -->
            <div class="moving-details" style="display: none;">
                <h6 class="text-muted mb-3">Teslim Adresi Detayları</h6>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Kat Numarası</label>
                        <input type="number" class="form-control" name="to_floor" min="0" max="50" placeholder="Örn: 5">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Daire (Oda Sayısı)</label>
                        <select class="form-select" name="to_room_count">
                            <option value="">Seçiniz</option>
                            <option value="1+0">1+0</option>
                            <option value="1+1">1+1</option>
                            <option value="2+1">2+1</option>
                            <option value="3+1">3+1</option>
                            <option value="4+1">4+1</option>
                            <option value="5+1">5+1 ve üzeri</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="to_has_elevator" id="to_has_elevator" value="true">
                            <label class="form-check-label" for="to_has_elevator">
                                Normal Asansör Var
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="to_has_freight_elevator" id="to_has_freight_elevator" value="true">
                            <label class="form-check-label" for="to_has_freight_elevator">
                                Yük Asansörü Var
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3 shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-4">
                <i class="bi bi-box-seam me-2"></i>Yük Bilgileri
            </h5>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">Ağırlık (kg) *</label>
                    <input type="number" class="form-control" name="weight" required min="1" step="0.01" placeholder="100" value="{{ prefill.weight|default:'' }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Uzunluk (cm)</label>
                    <input type="number" class="form-control" name="length" min="1" step="0.01" placeholder="Opsiyonel">
                </div>
                <div class="col-md-3">
                    <label class="form-label">En (cm)</label>
                    <input type="number" class="form-control" name="width" min="1" step="0.01" placeholder="Opsiyonel">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Boy (cm)</label>
                    <input type="number" class="form-control" name="height" min="1" step="0.01" placeholder="Opsiyonel">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label">Bütçeniz (₺) *</label>
                    <input type="number" class="form-control" name="suggested_price" required min="1" step="0.01" placeholder="1000" value="{{ prefill.suggested_price|default:'' }}">
                    <div class="form-text">Taşıyıcılar bu fiyat üzerinden teklif verecek</div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Yükleme *</label>
                    <select class="form-select" name="loading_responsibility" required>
                        {% for value, label in loading_choices %}
                        <option value="{{value}}">{{label}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">İndirme *</label>
                    <select class="form-select" name="unloading_responsibility" required>
                        {% for value, label in unloading_choices %}
                        <option value="{{value}}">{{label}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Alış Tarihi *</label>
                <input type="date" class="form-control" name="pickup_date" required value="{{ prefill.pickup_date|default:'' }}">
            </div>
        </div>
    </div>

    <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-circle me-2"></i>İlanı Yayınla
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Türkiye Şehirleri - Alfabetik Sırada
    const turkishCities = [
        'Adana', 'Adıyaman', 'Afyonkarahisar', 'Ağrı', 'Aksaray', 'Amasya', 'Ankara',
        'Antalya', 'Ardahan', 'Artvin', 'Aydın', 'Balıkesir', 'Bartın', 'Batman',
        'Bayburt', 'Bilecik', 'Bingöl', 'Bitlis', 'Bolu', 'Burdur', 'Bursa',
        'Çanakkale', 'Çankırı', 'Çorum', 'Denizli', 'Diyarbakır', 'Düzce', 'Edirne',
        'Elazığ', 'Erzincan', 'Erzurum', 'Eskişehir', 'Gaziantep', 'Giresun', 'Gümüşhane',
        'Hakkari', 'Hatay', 'Iğdır', 'Isparta', 'İstanbul', 'İzmir', 'Kahramanmaraş',
        'Karabük', 'Karaman', 'Kars', 'Kastamonu', 'Kayseri', 'Kırıkkale', 'Kırklareli',
        'Kırşehir', 'Kilis', 'Kocaeli', 'Konya', 'Kütahya', 'Malatya', 'Manisa',
        'Mardin', 'Mersin', 'Muğla', 'Muş', 'Nevşehir', 'Niğde', 'Ordu', 'Osmaniye',
        'Rize', 'Sakarya', 'Samsun', 'Siirt', 'Sinop', 'Sivas', 'Şanlıurfa', 'Şırnak',
        'Tekirdağ', 'Tokat', 'Trabzon', 'Tunceli', 'Uşak', 'Van', 'Yalova', 'Yozgat', 'Zonguldak'
    ];

    // Datalist'i doldur
    const datalist = document.getElementById('cities-list');
    if (datalist) {
        turkishCities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            datalist.appendChild(option);
        });
    }

    // City autocomplete için gelişmiş özellik
    const cityInputs = document.querySelectorAll('.city-autocomplete');
    cityInputs.forEach(input => {
        // Büyük harf dönüşümü
        input.addEventListener('input', function(e) {
            const value = this.value;
            // İlk harfi büyük yap
            if (value.length > 0) {
                this.value = value.charAt(0).toLocaleUpperCase('tr-TR') + value.slice(1).toLocaleLowerCase('tr-TR');
            }
        });

        // Enter tuşu ile seç
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = this.value.toLocaleLowerCase('tr-TR');
                const match = turkishCities.find(city =>
                    city.toLocaleLowerCase('tr-TR').startsWith(value)
                );
                if (match) {
                    this.value = match;
                }
            }
        });
    });

    // Cargo type toggle
    const cargoTypeSelect = document.querySelector('select[name="cargo_type"]');
    const movingDetailsElements = document.querySelectorAll('.moving-details');

    function toggleMovingDetails() {
        const selectedValue = cargoTypeSelect.value;
        const showDetails = selectedValue === 'evden_eve' || selectedValue === 'isyeri';

        movingDetailsElements.forEach(element => {
            element.style.display = showDetails ? 'block' : 'none';
        });
    }

    // Run on page load
    if (cargoTypeSelect) {
        toggleMovingDetails();
        // Run when cargo type changes
        cargoTypeSelect.addEventListener('change', toggleMovingDetails);
    }
});
</script>
