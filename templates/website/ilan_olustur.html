{% extends 'base.html' %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="h2 mb-4">Yeni İlan Oluştur</h1>
            <form method="post">
                {% csrf_token %}
                {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{message.tags}}">{{message}}</div>
                    {% endfor %}
                {% endif %}

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Temel Bilgiler</h5>
                        <div class="mb-3">
                            <label class="form-label">Başlık *</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Açıklama</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Yük Tipi *</label>
                                <select class="form-select" name="cargo_type" required>
                                    {% for value, label in cargo_types %}
                                    <option value="{{value}}">{{label}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Telefon *</label>
                                <input type="tel" class="form-control" name="phone" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Alış Adresi</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Şehir *</label>
                                <select class="form-select" name="from_city" required>
                                    <option value="">Şehir Seçiniz</option>
                                    {% for city in cities %}
                                    <option value="{{city}}">{{city}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">İlçe *</label>
                                <input type="text" class="form-control" name="from_district" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Adres *</label>
                            <textarea class="form-control" name="from_address" rows="2" required></textarea>
                        </div>

                        <!-- Evden Eve/Ofis Taşıma İçin Ek Sorular - Alış Adresi -->
                        <div class="moving-details" style="display: none;">
                            <h6 class="text-muted mb-3">Alış Adresi Detayları</h6>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Kat Numarası</label>
                                    <input type="number" class="form-control" name="from_floor" min="0" max="50" placeholder="Örn: 3">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Daire (Oda Sayısı)</label>
                                    <select class="form-select" name="from_room_count">
                                        <option value="">Seçiniz</option>
                                        <option value="1+0">1+0</option>
                                        <option value="1+1">1+1</option>
                                        <option value="2+1">2+1</option>
                                        <option value="3+1">3+1</option>
                                        <option value="4+1">4+1</option>
                                        <option value="5+1">5+1 ve üzeri</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" name="from_has_elevator" id="from_has_elevator" value="true">
                                        <label class="form-check-label" for="from_has_elevator">
                                            Normal Asansör Var
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" name="from_has_freight_elevator" id="from_has_freight_elevator" value="true">
                                        <label class="form-check-label" for="from_has_freight_elevator">
                                            Yük Asansörü Var
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5 class="card-title mt-4">Teslim Adresi</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Şehir *</label>
                                <select class="form-select" name="to_city" required>
                                    <option value="">Şehir Seçiniz</option>
                                    {% for city in cities %}
                                    <option value="{{city}}">{{city}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">İlçe *</label>
                                <input type="text" class="form-control" name="to_district" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Adres *</label>
                            <textarea class="form-control" name="to_address" rows="2" required></textarea>
                        </div>

                        <!-- Evden Eve/Ofis Taşıma İçin Ek Sorular - Teslim Adresi -->
                        <div class="moving-details" style="display: none;">
                            <h6 class="text-muted mb-3">Teslim Adresi Detayları</h6>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Kat Numarası</label>
                                    <input type="number" class="form-control" name="to_floor" min="0" max="50" placeholder="Örn: 5">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Daire (Oda Sayısı)</label>
                                    <select class="form-select" name="to_room_count">
                                        <option value="">Seçiniz</option>
                                        <option value="1+0">1+0</option>
                                        <option value="1+1">1+1</option>
                                        <option value="2+1">2+1</option>
                                        <option value="3+1">3+1</option>
                                        <option value="4+1">4+1</option>
                                        <option value="5+1">5+1 ve üzeri</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" name="to_has_elevator" id="to_has_elevator" value="true">
                                        <label class="form-check-label" for="to_has_elevator">
                                            Normal Asansör Var
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" name="to_has_freight_elevator" id="to_has_freight_elevator" value="true">
                                        <label class="form-check-label" for="to_has_freight_elevator">
                                            Yük Asansörü Var
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Yük Bilgileri</h5>
                        <div class="row mb-3">
                            <div class="col-md-3 weight-field">
                                <label class="form-label">Ağırlık (kg) *</label>
                                <input type="number" class="form-control weight-input" name="weight" required min="1" step="0.01">
                            </div>
                            <div class="col-md-3 dimension-field">
                                <label class="form-label">Uzunluk (cm)</label>
                                <input type="number" class="form-control dimension-input" name="length" min="1" step="0.01" placeholder="Opsiyonel">
                            </div>
                            <div class="col-md-3 dimension-field">
                                <label class="form-label">En (cm)</label>
                                <input type="number" class="form-control dimension-input" name="width" min="1" step="0.01" placeholder="Opsiyonel">
                            </div>
                            <div class="col-md-3 dimension-field">
                                <label class="form-label">Boy (cm)</label>
                                <input type="number" class="form-control dimension-input" name="height" min="1" step="0.01" placeholder="Opsiyonel">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Fiyat (₺) *</label>
                                <input type="number" class="form-control" name="suggested_price" required min="1" step="0.01">
                                <div class="form-text">Taşıyıcılar bu fiyat üzerinden teklif verecek</div>
                            </div>
                        </div>
                        <div class="row mb-3 loading-unloading-field">
                            <div class="col-md-6">
                                <label class="form-label">Yükleme *</label>
                                <select class="form-select loading-input" name="loading_responsibility" required>
                                    {% for value, label in loading_choices %}
                                    <option value="{{value}}">{{label}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">İndirme *</label>
                                <select class="form-select unloading-input" name="unloading_responsibility" required>
                                    {% for value, label in unloading_choices %}
                                    <option value="{{value}}">{{label}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Alış Tarihi *</label>
                            <input type="date" class="form-control" name="pickup_date" required>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 justify-content-end">
                    <a href="{% url 'website:ilanlar' %}" class="btn btn-secondary">İptal</a>
                    <button type="submit" class="btn btn-primary btn-lg">İlanı Yayınla</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cargoTypeSelect = document.querySelector('select[name="cargo_type"]');
    const movingDetailsElements = document.querySelectorAll('.moving-details');
    const weightField = document.querySelector('.weight-field');
    const weightInput = document.querySelector('.weight-input');
    const dimensionFields = document.querySelectorAll('.dimension-field');
    const dimensionInputs = {
        length: document.querySelector('input[name="length"]'),
        width: document.querySelector('input[name="width"]'),
        height: document.querySelector('input[name="height"]')
    };
    const loadingUnloadingField = document.querySelector('.loading-unloading-field');
    const loadingInput = document.querySelector('.loading-input');
    const unloadingInput = document.querySelector('.unloading-input');

    function toggleFields() {
        const selectedValue = cargoTypeSelect.value;

        // 1. Evden Eve / Ofis Taşıma için kat/asansör alanlarını göster
        const showMovingDetails = selectedValue === 'evden_eve' || selectedValue === 'isyeri' || selectedValue === 'beyaz_esya';
        movingDetailsElements.forEach(element => {
            element.style.display = showMovingDetails ? 'block' : 'none';
        });

        // 2. Evden eve ve ofis taşımada ağırlık alanını gizle
        const hideWeight = selectedValue === 'evden_eve' || selectedValue === 'isyeri' || selectedValue === 'beyaz_esya';
        if (weightField && weightInput) {
            weightField.style.display = hideWeight ? 'none' : 'block';
            weightInput.required = !hideWeight;
            if (hideWeight) {
                weightInput.value = '1'; // Backend için minimum değer
            }
        }

        // 3. Evden eve ve ofis taşımada boyut alanlarını gizle
        const hideDimensions = selectedValue === 'evden_eve' || selectedValue === 'isyeri';
        dimensionFields.forEach(field => {
            field.style.display = hideDimensions ? 'none' : 'block';
        });
        Object.values(dimensionInputs).forEach(input => {
            if (input) {
                input.required = false; // Hiçbir zaman zorunlu değil
                if (hideDimensions) {
                    input.value = '';
                }
            }
        });

        // 4. Evden eve ve ofis taşımada yükleme/indirme alanlarını gizle
        const hideLoadingUnloading = selectedValue === 'evden_eve' || selectedValue === 'isyeri';
        if (loadingUnloadingField) {
            loadingUnloadingField.style.display = hideLoadingUnloading ? 'none' : 'block';
            if (loadingInput && unloadingInput) {
                loadingInput.required = !hideLoadingUnloading;
                unloadingInput.required = !hideLoadingUnloading;
                // Evden eve ve ofis için varsayılan değerler
                if (hideLoadingUnloading) {
                    loadingInput.value = 'carrier'; // Taşıyıcı yapar
                    unloadingInput.value = 'carrier'; // Taşıyıcı yapar
                }
            }
        }

        // 5. Yük/Kargo taşıma için boyutları zorunlu yap
        const requireDimensions = selectedValue === 'diger' || selectedValue === 'parcali';
        if (!hideDimensions) {
            Object.values(dimensionInputs).forEach(input => {
                if (input) {
                    input.required = requireDimensions;
                    if (requireDimensions) {
                        input.placeholder = 'Zorunlu';
                    } else {
                        input.placeholder = 'Opsiyonel';
                    }
                }
            });
        }
    }

    // Sayfa yüklendiğinde çalıştır
    toggleFields();

    // Yük tipi değiştiğinde çalıştır
    cargoTypeSelect.addEventListener('change', toggleFields);
});
</script>

{% endblock %}
